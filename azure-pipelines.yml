trigger:
- master

pr:
- master

jobs:
- job: Windows
  pool:
    vmImage: 'windows-2019'
  steps:
  - checkout: self  # self represents the repo where the initial Pipelines YAML file was found
    submodules: recursive 
  # Initialize CMake
  - task: CMake@1
    inputs:
      workingDirectory: '$(Build.SourcesDirectory)/bin'
      cmakeArgs: '..  -DCMAKE_TOOLCHAIN_FILE=../cmake-toolchain/windows-amd64.cmake'
  # Build with CMake
  - task: CMake@1
    inputs:
      workingDirectory: '$(Build.SourcesDirectory)/bin'
      cmakeArgs: '--build .'
  # Execute unit tests
  - script: |
      cd bin\exe\AMD64\WindowsUserMode\Debug
      .\symcryptunittest_generic.exe
    displayName: 'Execute generic unit test'
    name: 'WindowsGenericUnitTest'
  - task: CopyFiles@2
    inputs:
      SourceFolder: 'bin'
      Contents: '**'
      TargetFolder: '$(build.artifactstagingdirectory)'
  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: 'drop-Windows-Generic'
      publishLocation: 'Container'

- job: Linux
  pool:
    vmImage: 'ubuntu-18.04'
  steps:
  - checkout: self  # self represents the repo where the initial Pipelines YAML file was found
    submodules: recursive 
  # Initialize CMake
  - task: CMake@1
    inputs:
      workingDirectory: '$(Build.SourcesDirectory)/bin'
      cmakeArgs: '..'
  # Build with CMake
  - task: CMake@1
    inputs:
      workingDirectory: '$(Build.SourcesDirectory)/bin'
      cmakeArgs: '--build .'
  # Execute unit tests
  - script: |
      cd bin/exe/x86_64/Generic
      ./symcryptunittest
    displayName: 'Execute generic unit test'
    name: 'LinuxGenericUnitTest'
  - task: CopyFiles@2
    inputs:
      SourceFolder: 'bin'
      Contents: '**'
      TargetFolder: '$(build.artifactstagingdirectory)'
  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: 'drop-Linux-Generic'
      publishLocation: 'Container'